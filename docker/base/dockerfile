FROM nvidia/cuda:12.4.1-cudnn-devel-ubuntu22.04

RUN apt update
RUN apt upgrade -y
RUN apt update
RUN apt install -y curl ca-certificates git zsh wget vim make cmake ninja-build clang-14 openssh-server

RUN mkdir /workspace
WORKDIR /workspace

# Zsh
RUN wget -O /etc/zsh/zshrc https://git.grml.org/f/grml-etc-core/etc/zsh/zshrc
RUN chsh -s /bin/zsh

# Install miniconda
RUN wget -O miniconda.sh https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-Linux-x86_64.sh && \
    chmod +x miniconda.sh && \
    ./miniconda.sh -b -p /opt/conda && \
    rm miniconda.sh

ENV PATH="/opt/conda/bin:${PATH}"

# Misc
# If you mount a git repo to /workspace, git will complain without this
RUN git config --global --add safe.directory /workspace
ENV USER=haydnj

# Clean up
RUN mamba clean -qya
RUN pip cache purge
RUN rm -rf /workspace/*
RUN apt autoremove -y
RUN apt autoclean -y

# Huggingface home (generally where the HF ecosystem will cache things)
RUN mkdir /huggingface
ENV HF_HOME=/huggingface

ENTRYPOINT [ "/bin/zsh" ]