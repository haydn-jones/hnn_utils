FROM nvidia/cuda:12.4.1-cudnn-runtime-ubuntu22.04

# Install runtime dependencies
RUN apt update && apt install -y \
    curl wget htop tmux \
    ca-certificates locales \
    git git-core gnupg zsh vim sudo && \
    apt clean && \
    rm -rf /var/lib/apt/lists/*

# Generate locale
RUN locale-gen en_US.UTF-8

# Set up UV
ENV CARGO_HOME="/opt/cargo"
ENV PATH="/opt/cargo/bin:$PATH"
ENV UV_NO_CACHE=1
ENV UV_COMPILE_BYTECODE=1

ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh && rm /uv-installer.sh

# Create venv
RUN uv venv /opt/venv
ENV VIRTUAL_ENV=/opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# ZSH
RUN chsh -s /bin/zsh
ARG ZSHRC_PATH=/etc/zsh/.zshrc
RUN wget -O ${ZSHRC_PATH} https://git.grml.org/f/grml-etc-core/etc/zsh/zshrc
ENV ZDOTDIR /etc/zsh

# Perms
RUN chmod -R 777 /opt /root /etc/zsh
RUN chmod +t /opt /root /etc/zsh

RUN mkdir /workspace
WORKDIR /workspace

# Misc
RUN git config --global --add safe.directory /workspace

# Huggingface home
RUN mkdir /huggingface
ENV HF_HOME=/huggingface

RUN mkdir -p /home/runai-home
RUN ln -s ${ZSHRC_PATH} /home/runai-home/.zshrc

ENTRYPOINT [ "/bin/zsh" ]