FROM nvidia/cuda:12.4.1-cudnn-runtime-ubuntu22.04

# Set environment variables
ENV CARGO_HOME="/opt/cargo" \
    PATH="/opt/cargo/bin:/opt/venv/bin:$PATH" \
    UV_NO_CACHE=1 \
    UV_COMPILE_BYTECODE=1 \
    VIRTUAL_ENV="/opt/venv" \
    ZDOTDIR="/etc/zsh" \
    HF_HOME="/huggingface"

# Install dependencies and set up the environment
RUN apt update && apt install -y --no-install-recommends \
    curl wget htop tmux \
    ca-certificates locales \
    git git-core gnupg zsh vim sudo \
    && apt clean \
    && rm -rf /var/lib/apt/lists/* \
    && locale-gen en_US.UTF-8 \
    && mkdir -p /workspace /huggingface /home/runai-home \
    && git config --global --add safe.directory /workspace

# Set up UV and create venv
ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh && rm /uv-installer.sh \
    && . /opt/cargo/env \
    && uv venv /opt/venv

# Set up ZSH
RUN chsh -s /bin/zsh \
    && wget -O /etc/zsh/.zshrc https://git.grml.org/f/grml-etc-core/etc/zsh/zshrc \
    && ln -s /etc/zsh/.zshrc /home/runai-home/.zshrc

# Set permissions
RUN chmod -R 777 /opt /root /etc/zsh \
    && chmod +t /opt /root /etc/zsh

WORKDIR /workspace

CMD ["/bin/zsh"]